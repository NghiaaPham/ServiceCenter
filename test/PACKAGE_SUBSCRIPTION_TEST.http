### ???????????????????????????????????????????????????????????????????????
### PACKAGE SUBSCRIPTION API - TEST FILE
### Customer mua gói, xem subscriptions, cancel
### ???????????????????????????????????????????????????????????????????????

@baseUrl = https://localhost:7077
@customerEmail = nghiadaucau1@gmail.com
@customerPassword = YourPassword123!

### ???????????????????????????????????????????????????????????????????????
### STEP 1: LOGIN AS CUSTOMER
### ???????????????????????????????????????????????????????????????????????

# @name loginCustomer
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "email": "{{customerEmail}}",
  "password": "{{customerPassword}}"
}

###
@customerToken = {{loginCustomer.response.body.$.data.token}}
@customerId = {{loginCustomer.response.body.$.data.userId}}

### ???????????????????????????????????????????????????????????????????????
### STEP 2: GET CUSTOMER PROFILE (to get vehicleId)
### ???????????????????????????????????????????????????????????????????????

# @name getProfile
GET {{baseUrl}}/api/customer/profile/me
Authorization: Bearer {{customerToken}}

### ???????????????????????????????????????????????????????????????????????
### STEP 3: GET MY VEHICLES
### ???????????????????????????????????????????????????????????????????????

# @name getVehicles
GET {{baseUrl}}/api/customer/profile/my-vehicles
Authorization: Bearer {{customerToken}}

###
@vehicleId = 101

### ???????????????????????????????????????????????????????????????????????
### STEP 4: BROWSE MAINTENANCE PACKAGES
### ???????????????????????????????????????????????????????????????????????

GET {{baseUrl}}/api/maintenance-packages?status=Active
Authorization: Bearer {{customerToken}}

### ???????????????????????????????????????????????????????????????????????
### STEP 5: VIEW PACKAGE DETAILS (v?i discount)
### ???????????????????????????????????????????????????????????????????????

GET {{baseUrl}}/api/maintenance-packages/2
Authorization: Bearer {{customerToken}}

### ???????????????????????????????????????????????????????????????????????
### STEP 6: PURCHASE PACKAGE (CREATE SUBSCRIPTION)
### ???????????????????????????????????????????????????????????????????????

# @name purchasePackage
POST {{baseUrl}}/api/package-subscriptions/purchase
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "packageId": 2,
  "vehicleId": {{vehicleId}},
  "customerNotes": "Mu?n ??t l?ch vào bu?i sáng, c?n ki?m tra k? phanh"
}

###
@subscriptionId = {{purchasePackage.response.body.$.data.subscriptionId}}

### ???????????????????????????????????????????????????????????????????????
### STEP 7: VIEW MY SUBSCRIPTIONS (List)
### ???????????????????????????????????????????????????????????????????????

GET {{baseUrl}}/api/package-subscriptions/my-subscriptions
Authorization: Bearer {{customerToken}}

### ???????????????????????????????????????????????????????????????????????
### STEP 8: VIEW MY SUBSCRIPTIONS (Filter by Active)
### ???????????????????????????????????????????????????????????????????????

GET {{baseUrl}}/api/package-subscriptions/my-subscriptions?statusFilter=Active
Authorization: Bearer {{customerToken}}

### ???????????????????????????????????????????????????????????????????????
### STEP 9: VIEW SUBSCRIPTION DETAILS (Full info)
### ???????????????????????????????????????????????????????????????????????

GET {{baseUrl}}/api/package-subscriptions/{{subscriptionId}}
Authorization: Bearer {{customerToken}}

### ???????????????????????????????????????????????????????????????????????
### STEP 10: VIEW SUBSCRIPTION USAGE (Remaining quantities)
### ???????????????????????????????????????????????????????????????????????

GET {{baseUrl}}/api/package-subscriptions/{{subscriptionId}}/usage
Authorization: Bearer {{customerToken}}

### ???????????????????????????????????????????????????????????????????????
### STEP 11: GET ACTIVE SUBSCRIPTIONS FOR VEHICLE
### Dùng khi ??t l?ch: ch?n xe ? hi?n th? subscriptions có s?n
### ???????????????????????????????????????????????????????????????????????

GET {{baseUrl}}/api/package-subscriptions/vehicle/{{vehicleId}}/active
Authorization: Bearer {{customerToken}}

### ???????????????????????????????????????????????????????????????????????
### STEP 12: TRY DUPLICATE PURCHASE (Should fail)
### ???????????????????????????????????????????????????????????????????????

POST {{baseUrl}}/api/package-subscriptions/purchase
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "packageId": 2,
  "vehicleId": {{vehicleId}},
  "customerNotes": "Mua l?i l?n n?a"
}

### Expected: 400 Bad Request
### Message: "B?n ?ã có subscription active cho gói này trên xe này r?i"

### ???????????????????????????????????????????????????????????????????????
### STEP 13: CANCEL SUBSCRIPTION
### ???????????????????????????????????????????????????????????????????????

POST {{baseUrl}}/api/package-subscriptions/{{subscriptionId}}/cancel
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "cancellationReason": "Không c?n s? d?ng n?a, mu?n ??i sang gói khác"
}

### ???????????????????????????????????????????????????????????????????????
### STEP 14: TRY TO VIEW CANCELLED SUBSCRIPTION
### ???????????????????????????????????????????????????????????????????????

GET {{baseUrl}}/api/package-subscriptions/{{subscriptionId}}
Authorization: Bearer {{customerToken}}

### Expected: Status should be "Cancelled"

### ???????????????????????????????????????????????????????????????????????
### NEGATIVE TESTS
### ???????????????????????????????????????????????????????????????????????

### ? TEST: Purchase with invalid PackageId
POST {{baseUrl}}/api/package-subscriptions/purchase
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "packageId": 0,
  "vehicleId": {{vehicleId}}
}

### Expected: 400 Bad Request - "PackageId ph?i l?n h?n 0"

###

### ? TEST: Purchase with invalid VehicleId
POST {{baseUrl}}/api/package-subscriptions/purchase
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "packageId": 2,
  "vehicleId": 0
}

### Expected: 400 Bad Request - "VehicleId ph?i l?n h?n 0"

###

### ? TEST: Purchase with non-existent PackageId
POST {{baseUrl}}/api/package-subscriptions/purchase
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "packageId": 999999,
  "vehicleId": {{vehicleId}}
}

### Expected: 400 Bad Request - "Không tìm th?y gói d?ch v? v?i ID: 999999"

###

### ? TEST: View subscription of another customer (Unauthorized)
GET {{baseUrl}}/api/package-subscriptions/999
Authorization: Bearer {{customerToken}}

### Expected: 403 Forbidden - "B?n không có quy?n truy c?p subscription này"

###

### ? TEST: Cancel subscription of another customer (Unauthorized)
POST {{baseUrl}}/api/package-subscriptions/999/cancel
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "cancellationReason": "Test unauthorized"
}

### Expected: 403 Forbidden - "B?n không có quy?n h?y subscription này"

###

### ? TEST: Cancel without reason
POST {{baseUrl}}/api/package-subscriptions/{{subscriptionId}}/cancel
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "cancellationReason": ""
}

### Expected: 400 Bad Request - "Lý do h?y không ???c ?? tr?ng"

###

### ? TEST: Cancel already cancelled subscription
POST {{baseUrl}}/api/package-subscriptions/{{subscriptionId}}/cancel
Authorization: Bearer {{customerToken}}
Content-Type: application/json

{
  "cancellationReason": "Try to cancel again"
}

### Expected: 400 Bad Request - "Ch? có th? h?y subscription ?ang Active ho?c Suspended"

### ???????????????????????????????????????????????????????????????????????
### VERIFICATION QUERIES (Run in SQL Server)
### ???????????????????????????????????????????????????????????????????????

/*
-- Check subscriptions created
SELECT 
    s.SubscriptionID,
    s.SubscriptionCode,
    s.CustomerID,
    s.PackageID,
    s.VehicleID,
    s.PurchaseDate,
    s.StartDate,
    s.ExpirationDate,
    s.OriginalPrice,
    s.DiscountPercent,
    s.DiscountAmount,
    s.PaymentAmount,
    s.Status,
    p.PackageName
FROM CustomerPackageSubscriptions s
JOIN MaintenancePackages p ON s.PackageID = p.PackageID
WHERE s.CustomerID = 1014
ORDER BY s.PurchaseDate DESC;

-- Check service usages
SELECT 
    u.UsageID,
    u.SubscriptionID,
    u.ServiceID,
    ms.ServiceName,
    u.TotalAllowedQuantity,
    u.UsedQuantity,
    u.RemainingQuantity,
    u.LastUsedDate,
    u.LastUsedAppointmentID
FROM PackageServiceUsages u
JOIN MaintenanceServices ms ON u.ServiceID = ms.ServiceID
WHERE u.SubscriptionID = @subscriptionId
ORDER BY u.ServiceID;

-- Check pricing breakdown
SELECT 
    SubscriptionID,
    PackageID,
    OriginalPrice AS 'Giá g?c',
    DiscountPercent AS 'Gi?m giá %',
    DiscountAmount AS 'S? ti?n gi?m',
    PaymentAmount AS 'Thành ti?n',
    Status
FROM CustomerPackageSubscriptions
WHERE SubscriptionID = @subscriptionId;
*/
