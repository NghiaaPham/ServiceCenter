-- ???????????????????????????????????????????????????????????????????????????
-- QUICK FIX: Update Appointment #1 v?i VIP 15% discount
-- Customer: Ph?m Nh?t Ngh?a (ID 1014) - VIP customer
-- ???????????????????????????????????????????????????????????????????????????

USE EVServiceCenterDB;
GO

-- 1?? VERIFY CURRENT STATE
PRINT '?? CURRENT STATE OF APPOINTMENT #1:';
PRINT '????????????????????????????????????????????????????????????????????';
SELECT 
    a.AppointmentID,
    a.AppointmentCode,
    a.CustomerID,
    c.FullName AS CustomerName,
    ct.TypeName AS CustomerType,
    ct.DiscountPercent AS CustomerTypeDiscount,
    a.EstimatedCost AS 'EstimatedCost (Current)',
    a.DiscountAmount AS 'DiscountAmount (Current)',
    a.DiscountType AS 'DiscountType (Current)',
    CASE 
        WHEN a.DiscountAmount IS NULL OR a.DiscountAmount = 0 THEN '? NO DISCOUNT'
        ELSE '? HAS DISCOUNT'
    END AS CurrentStatus
FROM Appointments a
INNER JOIN Customers c ON a.CustomerID = c.CustomerID
LEFT JOIN CustomerTypes ct ON c.TypeID = ct.TypeID
WHERE a.AppointmentID = 1;

PRINT '';
PRINT '?? APPOINTMENT SERVICES:';
PRINT '????????????????????????????????????????????????????????????????????';
SELECT 
    aps.AppointmentServiceID,
    aps.ServiceID,
    ms.ServiceName,
    aps.ServiceSource,
    aps.Price,
    aps.EstimatedTime
FROM AppointmentServices aps
INNER JOIN MaintenanceServices ms ON aps.ServiceID = ms.ServiceID
WHERE aps.AppointmentID = 1
ORDER BY aps.ServiceID;

-- 2?? CALCULATE DISCOUNT
DECLARE @AppointmentID INT = 1;
DECLARE @OriginalCost DECIMAL(18,2);
DECLARE @DiscountPercent DECIMAL(5,2);
DECLARE @DiscountAmount DECIMAL(18,2);
DECLARE @FinalCost DECIMAL(18,2);
DECLARE @CustomerTypeID INT;

-- Get current estimated cost (t?ng giá g?c)
SELECT @OriginalCost = ISNULL(EstimatedCost, 0)
FROM Appointments
WHERE AppointmentID = @AppointmentID;

-- Get customer type discount
SELECT @DiscountPercent = ct.DiscountPercent,
       @CustomerTypeID = ct.TypeID
FROM Appointments a
INNER JOIN Customers c ON a.CustomerID = c.CustomerID
LEFT JOIN CustomerTypes ct ON c.TypeID = ct.TypeID
WHERE a.AppointmentID = @AppointmentID;

-- Calculate discount amount và final cost
SET @DiscountAmount = @OriginalCost * (ISNULL(@DiscountPercent, 0) / 100.0);
SET @FinalCost = @OriginalCost - @DiscountAmount;

PRINT '';
PRINT '?? DISCOUNT CALCULATION:';
PRINT '????????????????????????????????????????????????????????????????????';
PRINT 'Original Cost: ' + CAST(@OriginalCost AS VARCHAR) + '?';
PRINT 'Customer Type Discount: ' + CAST(ISNULL(@DiscountPercent, 0) AS VARCHAR) + '%';
PRINT 'Discount Amount: ' + CAST(@DiscountAmount AS VARCHAR) + '?';
PRINT 'Final Cost: ' + CAST(@FinalCost AS VARCHAR) + '?';

-- 3?? UPDATE APPOINTMENT v?i discount
IF @DiscountPercent IS NOT NULL AND @DiscountPercent > 0
BEGIN
    PRINT '';
    PRINT '?? APPLYING FIX...';
    PRINT '????????????????????????????????????????????????????????????????????';
    
    UPDATE Appointments
    SET 
        EstimatedCost = @FinalCost,
        DiscountAmount = @DiscountAmount,
        DiscountType = 'CustomerType',
        UpdatedDate = GETUTCDATE(),
        UpdatedBy = 2067  -- Admin user
    WHERE AppointmentID = @AppointmentID;
    
    PRINT '? Appointment #' + CAST(@AppointmentID AS VARCHAR) + ' updated successfully!';
    PRINT '   - Original Cost: ' + CAST(@OriginalCost AS VARCHAR) + '?';
    PRINT '   - Discount (' + CAST(@DiscountPercent AS VARCHAR) + '%): -' + CAST(@DiscountAmount AS VARCHAR) + '?';
    PRINT '   - Final Cost: ' + CAST(@FinalCost AS VARCHAR) + '?';
END
ELSE
BEGIN
    PRINT '?? Customer không có CustomerType discount ? SKIP update';
END

-- 4?? VERIFY AFTER FIX
PRINT '';
PRINT '? VERIFY AFTER FIX:';
PRINT '????????????????????????????????????????????????????????????????????';
SELECT 
    a.AppointmentID,
    a.AppointmentCode,
    a.CustomerID,
    c.FullName AS CustomerName,
    ct.TypeName AS CustomerType,
    ct.DiscountPercent AS 'CustomerTypeDiscount%',
    a.EstimatedCost AS 'FinalCost',
    a.DiscountAmount AS 'DiscountAmount',
    a.DiscountType AS 'DiscountType',
    CASE 
        WHEN a.DiscountAmount IS NULL OR a.DiscountAmount = 0 THEN '? NO DISCOUNT'
        ELSE '? HAS DISCOUNT'
    END AS NewStatus,
    CONCAT('Ti?t ki?m: ', CAST(a.DiscountAmount AS VARCHAR), '? (', 
           CAST((a.DiscountAmount * 100.0 / (a.EstimatedCost + ISNULL(a.DiscountAmount, 0))) AS DECIMAL(5,2)), '%)') AS SavingsInfo
FROM Appointments a
INNER JOIN Customers c ON a.CustomerID = c.CustomerID
LEFT JOIN CustomerTypes ct ON c.TypeID = ct.TypeID
WHERE a.AppointmentID = 1;

PRINT '';
PRINT '?? FIX COMPLETED! Now test API: GET https://localhost:7077/api/appointments/1';
PRINT '';

GO
