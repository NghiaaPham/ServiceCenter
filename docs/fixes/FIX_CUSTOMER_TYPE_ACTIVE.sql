-- ???????????????????????????????????????????????????????????????????????
-- FIX CUSTOMER TYPE INACTIVE ISSUE
-- Ki?m tra và activate l?i CustomerTypes b? inactive
-- ???????????????????????????????????????????????????????????????????????

USE EVServiceCenterDB;
GO

PRINT '?? Checking CustomerTypes status...';
PRINT '';

-- ???????????????????????????????????????????????????????????????????????
-- 1?? CHECK CURRENT STATUS
-- ???????????????????????????????????????????????????????????????????????

SELECT 
    TypeID,
    TypeName,
    DiscountPercent,
    IsActive,
    CASE 
        WHEN IsActive = 1 THEN '? Active'
        WHEN IsActive = 0 THEN '? Inactive'
        ELSE '?? NULL'
    END AS StatusDisplay,
    (SELECT COUNT(*) FROM Customers WHERE TypeId = ct.TypeID) AS CustomerCount
FROM CustomerTypes ct
ORDER BY TypeID;

PRINT '';
PRINT '???????????????????????????????????????????????????????????????';
PRINT '';

-- ???????????????????????????????????????????????????????????????????????
-- 2?? FIX: ACTIVATE ALL CUSTOMER TYPES
-- ???????????????????????????????????????????????????????????????????????

PRINT '?? Activating all CustomerTypes...';

UPDATE CustomerTypes
SET IsActive = 1
WHERE IsActive = 0 OR IsActive IS NULL;

PRINT '? All CustomerTypes activated!';
PRINT '';

-- ???????????????????????????????????????????????????????????????????????
-- 3?? VERIFY AFTER FIX
-- ???????????????????????????????????????????????????????????????????????

PRINT '? Status after fix:';
PRINT '';

SELECT 
    TypeID,
    TypeName,
    DiscountPercent,
    IsActive,
    (SELECT COUNT(*) FROM Customers WHERE TypeId = ct.TypeID) AS CustomerCount,
    (SELECT COUNT(*) FROM Customers WHERE TypeId = ct.TypeID AND IsActive = 1) AS ActiveCustomerCount
FROM CustomerTypes ct
WHERE IsActive = 1
ORDER BY TypeID;

PRINT '';
PRINT '???????????????????????????????????????????????????????????????';
PRINT '';

-- ???????????????????????????????????????????????????????????????????????
-- 4?? CHECK CUSTOMERS AFFECTED
-- ???????????????????????????????????????????????????????????????????????

PRINT '?? Customers by Type:';
PRINT '';

SELECT 
    ct.TypeName,
    COUNT(c.CustomerId) AS TotalCustomers,
    COUNT(CASE WHEN c.IsActive = 1 THEN 1 END) AS ActiveCustomers,
    CONCAT(FORMAT(CAST(COUNT(c.CustomerId) AS FLOAT) / NULLIF((SELECT COUNT(*) FROM Customers), 0) * 100, 'N1'), '%') AS PercentageOfTotal
FROM CustomerTypes ct
LEFT JOIN Customers c ON ct.TypeID = c.TypeId
GROUP BY ct.TypeName
ORDER BY COUNT(c.CustomerId) DESC;

PRINT '';
PRINT '? Fix complete!';
GO
